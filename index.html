<!DOCTYPE html>
<html>
<body>
    <h2>E0322038 - Access Revocation Management System</h2>
    
    <input id="u" placeholder="user"> 
    <input id="p" type="password" placeholder="pass"> 
    <button onclick="go('/auth/register')">Register</button>
    <button onclick="go('/auth/login')">Log In</button>
    
    <div id="out" style="margin-top:20px; font-family:monospace"></div>

    <script>
        let t = '';
        const API = ''; // Leave blank if serving from same domain

        async function go(path) {
            try {
                const r = await fetch(API + path, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u.value, password: p.value, role: 'USER'}) 
                });
                
                // If it's a 401 or 403, it might not be JSON
                if (!r.ok) {
                    const txt = await r.text();
                    alert('Server says: ' + txt);
                    return;
                }

                const d = await r.json();
                if(d.token) {
                    t = d.token;
                    document.getElementById('out').innerHTML = `Logged in as: ${d.role} <br> <button onclick="check()">Check Status</button> <button onclick="list()">Admin List</button>`;
                } else { 
                    alert('Done/Success'); 
                }
            } catch (e) {
                console.error(e);
                alert('Error: Check Console');
            }
        }

        async function check() {
            const r = await fetch(API + '/status', {headers: {'Authorization': 'Bearer ' + t}});
            const d = await r.json();
            document.getElementById('out').innerHTML += `<br>Access: ${d.hasAccess}`;
        }

        async function list() {
            const r = await fetch(API + '/admin/users', {headers: {'Authorization': 'Bearer ' + t}});
            if (r.status === 403) {
                alert("Access Denied: Admin Only");
                return;
            }
            const d = await r.json();
            document.getElementById('out').innerHTML = d.map(user => `
                <div>${user.username} | Access: ${user.hasAccess} <button onclick="flip('${user._id}')">Flip</button></div>
            `).join('');
        }

        async function flip(id) {
            await fetch(API + '/admin/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + t},
                body: JSON.stringify({userId: id})
            });
            list();
        }
    </script>
</body>
</html>
